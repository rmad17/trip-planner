# Caddyfile for Trip Planner API
# Replace api.yourdomain.com with your actual domain

# API Server Configuration
api.yourdomain.com {
    # Automatic HTTPS with Let's Encrypt
    # Caddy handles SSL certificates automatically

    # Enable compression
    encode gzip zstd

    # CORS headers for Digital Ocean Spaces frontend
    @cors_preflight {
        method OPTIONS
    }

    # Handle CORS preflight requests
    handle @cors_preflight {
        header {
            Access-Control-Allow-Origin "https://trip-planner-fe.blr1.digitaloceanspaces.com"
            Access-Control-Allow-Origin "https://trip-planner-fe.blr1.cdn.digitaloceanspaces.com"
            Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
            Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, User-Agent, Cache-Control, X-Requested-With"
            Access-Control-Allow-Credentials "true"
            Access-Control-Max-Age "86400"
        }
        respond 204
    }

    # Proxy all requests to the Go API
    reverse_proxy api:8080 {
        # Health check
        health_uri /health
        health_interval 30s
        health_timeout 10s

        # Headers
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}

        # Add CORS headers to all responses
        header_down Access-Control-Allow-Origin "https://trip-planner-fe.blr1.digitaloceanspaces.com"
        header_down Access-Control-Allow-Credentials "true"
        header_down Access-Control-Expose-Headers "Content-Length, Content-Range"
    }

    # Rate limiting (optional but recommended)
    # rate_limit {
    #     zone dynamic {
    #         key {remote_host}
    #         events 100
    #         window 1m
    #     }
    # }

    # Logging
    log {
        output file /data/access.log {
            roll_size 100mb
            roll_keep 5
        }
        format json
    }

    # File upload size limit
    request_body {
        max_size 50MB
    }
}

# Alternative: If you want to use IP address instead of domain (development)
# :80, :443 {
#     reverse_proxy api:8080
# }
